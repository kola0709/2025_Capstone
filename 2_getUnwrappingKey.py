import pickle
import binascii
from cryptography.hazmat.primitives.keywrap import aes_key_unwrap
from cryptography.hazmat.primitives.ciphers import algorithms

# ../keyBag/personalKey.pkl load
with open('../keyBag/personalKey.pkl', 'rb') as f:
    personalKey = pickle.load(f)
    
# debug key len
# print("personal pw hash length:", len(personalKey))

# input [WPKY]

# WPKY for CLAS 1 UUID : 00000010 6B271778 E4B444D3 8F4F95B0 43A76C7E
# wrappedKey = binascii.unhexlify("0611CAD9B5E9E7E324A841FA59CFE51E3BDAD861F508AC5C8383B208637E5A7FB11B55DAA8EBB610")

# WPKY for CLAS 2 UUID : 00000010 9FCC7896 306E4E15 8A208BC3 DBC11054
# wrappedKey = binascii.unhexlify("326ED9511AFCEFABA401B34739DB8BC4B798D84560C4558FD1080EEBCB3F6FE5384E06B4B94B61A7")

# WPKY for CLAS 3 UUID : 00000010 FE0BBAA6 966548A7 BCC487A6 018D5B9D
# wrappedKey = binascii.unhexlify("C7DD2DC28F36EBCCF1E75E4F208D01C69CB5EC9DA50B02D10AC9A2C90E48EEEB976A5E0593A0E2B2")

# WPKY for CLAS 4 UUID : 00000010 42AE67D1 584D4167 811F7967 EB4C48EB
# wrappedKey = binascii.unhexlify("C5AF09F0B3BB2F21D03C8DEE36CAC5D438F84CE6E1ABD794F8F10D54F8D535CA2812ABA593CED6F7")

# WPKY for CLAS 5 UUID : 00000010 CFEC77C9 5F2649A5 97E4D6FB C08E1C6F
# wrappedKey = binascii.unhexlify("8525F3099AEF7B4C37B7EB645642E2000A6C685BC965267D4BC2A6B88FC3CEF0E429CF3C32E470C4")

# WPKY for CLAS 6 UUID : 00000010 23737570 B3AE4684 91F26873 D5CC4EDA
# wrappedKey = binascii.unhexlify("190895789FBEFA954677F64E52244326BEEFBAA7CEA599E458A6727452D655BE3060F65ED1EB91E9")

# WPKY for CLAS 7 UUID : 00000010 22063B73 473A44A3 B633CC40 1ABD9E8F
# wrappedKey = binascii.unhexlify("413E4DC3A54E538DE5243A3DBB230F3C5AAB5D8D6A7852CD518D6C7FAB8A1D02A9662A45159C5BDF")

# WPKY for CLAS 8 UUID : 00000010 B9A9EE82 8F0B4CEB B3C20F07 56FFF3B4
# wrappedKey = binascii.unhexlify("20953D1624F2C6E873C4B425ED5621755FF2A16C681043BF8F0B82CAAD643396CCC13853C909FB7A")

# WPKY for CLAS 9 UUID : 00000010 5E292EA1 94954C60 9E64D8D7 0E843475
# wrappedKey = binascii.unhexlify("1C147445A7388AC68416B4738F7B2842298DB9746D429218CE9100A0121EE8F3D5ED2D51D7DDC310")

# WPKY for CLAS A(10) UUID : 00000010 2078C7BA 393047A1 93EFC6F8 72818837
# wrappedKey = binascii.unhexlify("7E05479A476B5743136E62EBA9E5766A6C14372B7EF0ADF37CC54835FE57C22A036FCADD0AAB68D0")

# WPKY for CLAS B(11) UUID : 00000010 6B6C58BD C44243D9 BA9D8E93 A1009182
# wrappedKey = binascii.unhexlify("41040077887E76BEFD324B7B75BC876D83729CD07FAC5F7B389ED411241C69D566145C72BB7A57C9")

# WPKY for CLAS C(12) UUID : 00000010 B805D425 E00F4435 BEA3B8AA 6D090828
# wrappedKey = binascii.unhexlify("F121F8726A7DA8733B5F8049C0C64CB543D87A9CC1C2AD69579EB3CFCB4122E2CE4DA5AA711D980E")

# WPKY for CLAS D(13) UUID : 00000010 31951AAD 530C469D 9F705A0E 3A30E937
wrappedKey = binascii.unhexlify("A2642C63DA583B6701292BC04691AD3106B331A974D8F7B42ED3FC9B9CE8EB7187F2B259C77407E8")

try:
    unwrappedKey = aes_key_unwrap(personalKey, wrappedKey, algorithms.AES)
    
    # print unwrappedKey
    print("unwrappedKey :", binascii.hexlify(unwrappedKey).decode())
    
    with open('../keyBag/CLAS13D_UWPKY.pkl', 'wb') as f:
        pickle.dump(unwrappedKey, f)
        print("WPKY saved at ../keyBag/CLAS13D_UWPKY.pkl")
except Exception as e:
    print("Error during unwrapping:", str(e))